<html>
	<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="dist/splinterlands.min.css" />

		<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
		<script src="dist/splinterlands.min.js"></script>
		<script type="text/javascript">
			$(() =>	setTimeout(init, 500));

			async function init() {
				await splinterlands.init({ api_url: 'https://testnet.steemmonsters.io', ws_url: 'wss://sm-ws.mrosen.com' });
				//await splinterlands.init({ api_url: 'http://localhost:3000', ws_url: 'ws://localhost:3001' });

				if(splinterlands.has_saved_login())
					savedLogin();
				
				// If the steem keychain browser extension is not present, show the password login option
				if(!window.steem_keychain) {
					$('#chk_pwd_login').prop('checked', true);
					$('#div_pwd_login').show();
          $('#btn_login_keychain').hide();
				}
      }
      
      async function savedLogin() {
				ShowLoading();

        let login_response = await splinterlands.login();

        if(!login_response.error)
					onLogin(login_response);
					
				HideLoading();
      }

			window.addEventListener('splinterlands:version_change', e => {
				alert(`New Version - ${e.detail}!`);
			}, false);
		</script>

		<style type="text/css">
			.modal-backdrop.in {
				opacity: 0.8;
			}

			.loading {
				position: fixed;
				width: 200px;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}
		</style>
	</head>
	<body>
    <div class="container">
      <div id="div_login" class="py-3">
        <input type="text" id="username" placeholder="account name"/>
        <button id="btn_login_keychain">Log In With Keychain</button>
        <br/>
        <div id="div_pwd_login" style="display: none;">
          <input type="password" id="password" />
          <button id="btn_login_pwd">Log In With Password</button>
        </div>
        <label><input type="checkbox" id="chk_pwd_login"/> Log in with password</label><br/>
      </div>

      <div id="div_game" style="display: none;">
        <div class="py-3">
					Logged in as: 
					<img id="player_profile_img" style="height: 30px; width: 30px; border-radius: 15px;" />
					@<span id="span_username"></span>
          <button id="btn_logout">Log Out</button>
        </div>

				<div style="display: flex">
					<div class="py-1">
						<h5>Balances:</h5>
						<div>DEC: <span id="span_balance_dec"></span></div>
						<div>BETA: <span id="span_balance_beta"></span></div>
						<div>ALPHA: <span id="span_balance_alpha"></span></div>
						<div>ORB: <span id="span_balance_orb"></span></div>
					</div>
					
					<div style="text-align: center; width: 300px;">
						<h5>League:</h5>
						<img id="img_league" src="" style="height: 75px;" />
						<div id="league_name"></div>
						<div id="season_ends"></div>
					</div>

					<div>
						<h5>Quest:</h5>
						<div id="quest_info"></div>
						<button id="btn_claim_quest_rewards" style="display: none;">CLAIM REWARDS</button>
						<button id="btn_start_quest" style="display: none;">START QUEST</button>
						<button id="btn_refresh_quest" style="display: none;">NEW QUEST</button>
					</div>
				</div>
      </div>

      <div class="py-1">
        <table id="tbl_collection" class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Edition</th>
              <th>Foil</th>
              <th>Level</th>
              <th>Num Cards</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <script type="text/javascript">
      function onLogin(player) {
        $('#div_login').hide();
        $('#div_game').show();
				$('#span_username').text(player.name);
				$('#player_profile_img').attr('src', player.profile_image);

        ['DEC', 'BETA', 'ALPHA', 'ORB'].forEach(async token => {
          let balance = await player.get_balance(token);
          $(`#span_balance_${token.toLowerCase()}`).text(balance);
				});
				
				$('#img_league').attr('src', player.league.image);
				$('#league_name').text(player.league.name);

				setInterval(() => $('#season_ends').text(`Season ends in: ${countdownStr(new Date(splinterlands.get_settings().season.ends).getTime() - Date.now(), true)}`), 1000);

				showQuestInfo(player.quest);
        showCollection();
      }

      function showCollection() {
        let tbody = $('#tbl_collection tbody');

        splinterlands.group_collection().forEach(card => {
          let row = $('<tr>');

          row.append(`<td>${card.details.name}</td>`);
          row.append(`<td>${splinterlands.utils.get_edition_str(card.edition)}</td>`);
          row.append(`<td>${card.gold ? 'Gold' : 'Regular'}</td>`);
          row.append(`<td>${card.level || '--'}</td>`);
          row.append(`<td>${card.cards.length}</td>`);

          let img_td = $('<td></td>');
          img_td.append(card.render('sm'));
          row.append(img_td);

          tbody.append(row);
        });
      }

      $('#btn_login_keychain').click(async () => {
				ShowLoading();
				let login_response = await splinterlands.login($('#username').val());
				HideLoading();

        if(login_response.error) {
          alert(`Error logging in: ${login_response.error}`);
          return;
        }

        onLogin(login_response);
			});
			
			$('#btn_login_pwd').click(async () => {
				ShowLoading();
				let login_response = await splinterlands.login($('#username').val(), $('#password').val());
				HideLoading();

        if(login_response.error) {
          alert(`Error logging in: ${login_response.error}`);
          return;
        }

        onLogin(login_response);
      });

      $('#chk_pwd_login').click(() => {
        if($('#chk_pwd_login').prop('checked')) {
          $('#div_pwd_login').show();
          $('#btn_login_keychain').hide();
        } else {
          $('#div_pwd_login').hide();
          $('#btn_login_keychain').show();
        }
      });

      $('#btn_logout').click(() => { 
        splinterlands.logout();
        $('#div_login').show();
				$('#div_game').hide();
				clearInterval(quest_interval);
			});

			$('#btn_refresh_quest').click(async () => {
				ShowLoading();
				let result = await splinterlands.ops.refresh_quest();
				console.log(result);

				if(result && result.quest)
					showQuestInfo(result.quest);
					
				HideLoading();
			});

			$('#btn_start_quest').click(async () => {
				ShowLoading();
				let result = await splinterlands.ops.start_quest();
				console.log(result);

				if(result && result.quest)
					showQuestInfo(result.quest);
					
				HideLoading();
			});

			$('#btn_claim_quest_rewards').click(async () => {
				ShowLoading();
				let result = await splinterlands.get_player().quest.claim_rewards();
				console.log(result);

				// TODO: Show cards

				if(result && result.quest)
					showQuestInfo(result.quest);

				HideLoading();
			});

			var quest_interval = -1;
			function showQuestInfo(quest) {
				clearInterval(quest_interval);

				$('#quest_info').empty();
				$('#btn_start_quest').hide();
				$('#btn_refresh_quest').hide();
				$('#btn_claim_quest_rewards').hide();

				if(quest.can_start)
					$('#btn_start_quest').show();
				
				if(quest.can_refresh)
					$('#btn_refresh_quest').show();

				if(!quest.claimed)	{
					if(quest.completed)
						$('#btn_claim_quest_rewards').show();

					if(quest.details)
						$('#quest_info').html(`${quest.details.name}<br/>${quest.details.objective_short}<br/>Progress: ${quest.completed_items} / ${quest.total_items}`);
				} else if(quest.next > 0) {
					quest_interval = setInterval(() => $("#quest_info").text(`Quest available in: ${countdownStr(quest.next)}`), 1000);
				}
			}

			function padLeft(nr, n, str) {
				if (String(nr).length > n) return String(nr);
				return Array(n - String(nr).length + 1).join(str || '0') + nr;
			}

			function countdownStr(ts, days) {
				if(ts <= 0)
					return '00:00:00' + (days ? ':00' : '');

				let time_str = '';

				if(days)
					time_str += padLeft(Math.floor(ts / (24 * 60 * 60 * 1000)), 2, '0') + ':';

				time_str += padLeft(Math.floor((ts % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000)), 2, '0') + ':';
				time_str += padLeft(Math.floor((ts % (60 * 60 * 1000)) / 60000), 2, '0') + ':';
				time_str += padLeft(Math.floor((ts % 60000) / 1000), 2, '0');
				return time_str;
			}

			function ShowLoading() {
				let loading = $('<div class="modal-backdrop fade in loading-backdrop"><img src="https://s3.amazonaws.com/steemmonsters/website/loading.gif" class="loading" /></div>');
				loading.appendTo('body');
			}

			function HideLoading() { $('.loading-backdrop').remove(); }
    </script>
	</body>
</html>